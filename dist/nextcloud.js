var NextcloudAuth=function(){"use strict";const e="_oauth2_session";function t(e){return btoa(String.fromCharCode(...new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function n(){const e=t(crypto.getRandomValues(new Uint8Array(32)));return function(e){const t=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",t)}(e).then(n=>({verifier:e,challenge:t(n)}))}function r(t){sessionStorage.setItem(e,JSON.stringify(t))}function o(){const t=sessionStorage.getItem(e);return t?JSON.parse(t):null}function i(){sessionStorage.removeItem(e)}class s{_redirect_url=window.location.origin+window.location.pathname;constructor(e,t,n,r){this._auth_url=e,this._token_url=t,this._client_id=n,this._client_secret=r,addEventListener("load",this._callback.bind(this))}isLoggedIn(){const e=o();return Boolean(e?.access_token)}getAuth(){const e=o();if(e?.access_token)return e.token_type+" "+e.access_token}startLogin(){n().then(({verifier:e,challenge:t})=>{const n=crypto.randomUUID();r({verifier:e,state:n});const o=new URL(this._auth_url);o.search=new URLSearchParams({response_type:"code",client_id:this._client_id,redirect_uri:this._redirect_url,code_challenge_method:"S256",code_challenge:t,state:n}).toString(),window.location.assign(o.toString())})}_callback(){const e=new URL(window.location.href);if(!e.searchParams.has("code"))return;const t=e.searchParams.get("code"),n=e.searchParams.get("state"),s=o();if(!s||s.state!==n)return console.error("OAuth state mismatch"),void i();fetch(this._token_url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({grant_type:"authorization_code",client_id:this._client_id,client_secret:this._client_secret||"",redirect_uri:this._redirect_url,code_verifier:s.verifier||"",code:t||""})}).then(e=>e.json()).then(e=>{r({access_token:e.access_token,refresh_token:e.refresh_token,token_type:e.token_type}),window.history.replaceState({},"",this._redirect_url)}).catch(e=>{throw i(),e})}}return class extends s{constructor(e,t,n){super(new URL("/index.php/apps/oauth2/authorize",e).toString(),new URL("/index.php/apps/oauth2/api/v1/token",e).toString(),t,n)}}}();//# sourceMappingURL=nextcloud.js.map
