var NextcloudAuth=function(){"use strict";const e="nc_oauth";function t(e){return btoa(String.fromCharCode(...new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function n(){const e=t(crypto.getRandomValues(new Uint8Array(32)));return function(e){const t=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",t)}(e).then(n=>({verifier:e,challenge:t(n)}))}function r(t){sessionStorage.setItem(e,JSON.stringify(t))}function o(){const t=sessionStorage.getItem(e);return t?JSON.parse(t):null}function c(){sessionStorage.removeItem(e)}return class{_redirect_url=window.location.origin+window.location.pathname;constructor(e,t,n){this._base_url=e,this._client_id=t,this._client_secret=n,addEventListener("load",this._callback.bind(this))}isLoggedIn(){const e=o();return Boolean(e?.access_token)}getAuth(){const e=o();return e?.access_token?e.token_type+" "+e.access_token:null}startLogin(){n().then(({verifier:e,challenge:t})=>{const n=crypto.randomUUID();r({verifier:e,state:n});const o=new URL("/index.php/apps/oauth2/authorize",this._base_url);o.search=new URLSearchParams({response_type:"code",client_id:this._client_id,redirect_uri:this._redirect_url,code_challenge_method:"S256",code_challenge:t,state:n}).toString(),window.location.replace(o.toString())})}_callback(){const e=new URL(window.location.href);if(!e.searchParams.has("code"))return;const t=e.searchParams.get("code"),n=e.searchParams.get("state"),i=o();if(!i||i.state!==n)return console.error("OAuth state mismatch"),void c();fetch(`${this._base_url}/index.php/apps/oauth2/api/v1/token`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({grant_type:"authorization_code",client_id:this._client_id,client_secret:this._client_secret,redirect_uri:this._redirect_url,code_verifier:i.verifier,code:t})}).then(e=>e.json()).then(e=>{r({access_token:e.access_token,refresh_token:e.refresh_token,token_type:e.token_type}),window.history.replaceState({},"",this._redirect_url)}).catch(e=>{throw c(),e})}}}();//# sourceMappingURL=nextcloud.js.map
