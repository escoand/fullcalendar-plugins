{"version":3,"file":"caldav.js","sources":["../src/caldav.js"],"sourcesContent":["// ical helpers\nconst padNumber = (number, length = 2) => (\"000000000\" + number).slice(-length);\nconst icalDate = (date) => {\n  return (\n    date.getUTCFullYear() +\n    padNumber(date.getUTCMonth() + 1) +\n    padNumber(date.getUTCDate()) +\n    \"T\" +\n    padNumber(date.getUTCHours()) +\n    padNumber(date.getUTCMinutes()) +\n    padNumber(date.getUTCSeconds()) +\n    \"Z\"\n  );\n};\nconst parseIcal = (ical, start, end) => {\n  const createEvent = (event, start, end) => {\n    const obj = {\n      classNames: []\n        .concat(\n          (\n            (event.description && event.description.match(/#[a-zA-Z0-9]+/g)) ||\n            []\n          ).map((item) => `category-${item.substr(1)}`)\n        )\n        .concat(\n          (event._firstProp(\"status\") && [\n            `status-${event._firstProp(\"status\").toLowerCase()}`,\n          ]) ||\n            []\n        ),\n      description: event.description,\n      end: end ? end.toString() : event.endDate.toString(),\n      location: event.location,\n      start: start ? start.toString() : event.startDate.toString(),\n      title: event.summary,\n    };\n    if (\n      event.description &&\n      event.description.match(new RegExp(\"https?://[^ ]+\"))\n    ) {\n      obj.url = event.description.match(new RegExp(\"https?://[^ ]+\"))[0];\n    }\n    return obj;\n  };\n\n  const jcal = ICAL.parse(ical);\n  const comp = new ICAL.Component(jcal);\n  return comp.getAllSubcomponents(\"vevent\").flatMap((item) => {\n    const event = new ICAL.Event(item);\n    if (event.isRecurring()) {\n      const result = [];\n      const _start = new ICAL.Time().fromJSDate(start);\n      const _end = new ICAL.Time().fromJSDate(end);\n      const iter = event.iterator();\n      let next;\n      while ((next = iter.next()) && next.compare(_end) <= 0) {\n        if (next.compare(_start) >= 0) {\n          const occ = event.getOccurrenceDetails(next);\n          result.push(createEvent(occ.item, occ.startDate, occ.endDate));\n        }\n      }\n      return result;\n    } else if (!event.isRecurrenceException()) {\n      return [createEvent(event)];\n    } else {\n      return [];\n    }\n  });\n};\n\nexport default (url, props = {}) => {\n  return Object.assign(props, {\n    events: (fetchInfo, successCallback, failureCallback) => {\n      const xhr = new XMLHttpRequest();\n      xhr.open(\"REPORT\", url);\n      xhr.onload = () => {\n        if (xhr.status >= 200 && xhr.status < 400) {\n          const parser = new DOMParser();\n          const xml = parser.parseFromString(xhr.response, \"text/xml\");\n          const items = xml.getElementsByTagName(\"cal:calendar-data\");\n          const events = [];\n          for (let i = 0; i < items.length; i++) {\n            events.push(\n              ...parseIcal(items[i].innerHTML, fetchInfo.start, fetchInfo.end)\n            );\n          }\n          successCallback(events);\n        } else {\n          failureCallback(\"failed to fetch\", xhr);\n        }\n      };\n      xhr.onerror = () => failureCallback(\"failed to fetch\", xhr);\n      xhr.setRequestHeader(\"Depth\", \"1\");\n      xhr.send(\n        '<?xml version=\"1.0\" encoding=\"utf-8\" ?>' +\n          '<x1:calendar-query xmlns:x1=\"urn:ietf:params:xml:ns:caldav\">' +\n          '<x0:prop xmlns:x0=\"DAV:\">' +\n          \"<x1:calendar-data/>\" +\n          \"</x0:prop>\" +\n          \"<x1:filter>\" +\n          '<x1:comp-filter name=\"VCALENDAR\">' +\n          '<x1:comp-filter name=\"VEVENT\">' +\n          \"<x1:time-range \" +\n          'start=\"' +\n          icalDate(fetchInfo.start) +\n          '\" ' +\n          'end=\"' +\n          icalDate(fetchInfo.end) +\n          '\"/>' +\n          \"</x1:comp-filter>\" +\n          \"</x1:comp-filter>\" +\n          \"</x1:filter>\" +\n          \"</x1:calendar-query>\"\n      );\n    },\n  });\n};\n"],"names":["padNumber","number","length","slice","icalDate","date","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","parseIcal","ical","start","end","createEvent","event","obj","classNames","concat","description","match","map","item","substr","_firstProp","toLowerCase","toString","endDate","location","startDate","title","summary","RegExp","url","jcal","ICAL","parse","Component","getAllSubcomponents","flatMap","Event","isRecurring","next","result","_start","Time","fromJSDate","_end","iter","iterator","compare","occ","getOccurrenceDetails","push","isRecurrenceException","props","Object","assign","events","fetchInfo","successCallback","failureCallback","xhr","XMLHttpRequest","open","onload","status","items","DOMParser","parseFromString","response","getElementsByTagName","i","innerHTML","onerror","setRequestHeader","send"],"mappings":"41BACA,IAAMA,EAAY,SAACC,OAAQC,yDAAS,SAAO,YAAcD,GAAQE,OAAOD,IAClEE,EAAW,SAACC,UAEdA,EAAKC,iBACLN,EAAUK,EAAKE,cAAgB,GAC/BP,EAAUK,EAAKG,cACf,IACAR,EAAUK,EAAKI,eACfT,EAAUK,EAAKK,iBACfV,EAAUK,EAAKM,iBACf,KAGEC,EAAY,SAACC,EAAMC,EAAOC,OACxBC,EAAc,SAACC,EAAOH,EAAOC,OAC3BG,EAAM,CACVC,WAAY,GACTC,QAEIH,EAAMI,aAAeJ,EAAMI,YAAYC,MAAM,mBAC9C,IACAC,KAAI,SAACC,4BAAqBA,EAAKC,OAAO,QAEzCL,OACEH,EAAMS,WAAW,WAAa,kBACnBT,EAAMS,WAAW,UAAUC,iBAErC,IAENN,YAAaJ,EAAMI,YACnBN,IAAKA,EAAMA,EAAIa,WAAaX,EAAMY,QAAQD,WAC1CE,SAAUb,EAAMa,SAChBhB,MAAOA,EAAQA,EAAMc,WAAaX,EAAMc,UAAUH,WAClDI,MAAOf,EAAMgB,gBAGbhB,EAAMI,aACNJ,EAAMI,YAAYC,MAAM,IAAIY,OAAO,qBAEnChB,EAAIiB,IAAMlB,EAAMI,YAAYC,MAAM,IAAIY,OAAO,mBAAmB,IAE3DhB,GAGHkB,EAAOC,KAAKC,MAAMzB,UACX,IAAIwB,KAAKE,UAAUH,GACpBI,oBAAoB,UAAUC,SAAQ,SAACjB,OAC3CP,EAAQ,IAAIoB,KAAKK,MAAMlB,MACzBP,EAAM0B,cAAe,SAKnBC,EAJEC,EAAS,GACTC,GAAS,IAAIT,KAAKU,MAAOC,WAAWlC,GACpCmC,GAAO,IAAIZ,KAAKU,MAAOC,WAAWjC,GAClCmC,EAAOjC,EAAMkC,YAEXP,EAAOM,EAAKN,SAAWA,EAAKQ,QAAQH,IAAS,MAC/CL,EAAKQ,QAAQN,IAAW,EAAG,KACvBO,EAAMpC,EAAMqC,qBAAqBV,GACvCC,EAAOU,KAAKvC,EAAYqC,EAAI7B,KAAM6B,EAAItB,UAAWsB,EAAIxB,iBAGlDgB,EACF,OAAK5B,EAAMuC,wBAGT,GAFA,CAACxC,EAAYC,wBAOVkB,OAAKsB,yDAAQ,UACpBC,OAAOC,OAAOF,EAAO,CAC1BG,OAAQ,SAACC,EAAWC,EAAiBC,OAC7BC,EAAM,IAAIC,eAChBD,EAAIE,KAAK,SAAU/B,GACnB6B,EAAIG,OAAS,cACPH,EAAII,QAAU,KAAOJ,EAAII,OAAS,IAAK,SAGnCC,GAFS,IAAIC,WACAC,gBAAgBP,EAAIQ,SAAU,YAC/BC,qBAAqB,qBACjCb,EAAS,GACNc,EAAI,EAAGA,EAAIL,EAAMnE,OAAQwE,IAChCd,EAAOL,WAAPK,IACKhD,EAAUyD,EAAMK,GAAGC,UAAWd,EAAU/C,MAAO+C,EAAU9C,OAGhE+C,EAAgBF,QAEhBG,EAAgB,kBAAmBC,IAGvCA,EAAIY,QAAU,kBAAMb,EAAgB,kBAAmBC,IACvDA,EAAIa,iBAAiB,QAAS,KAC9Bb,EAAIc,KACF,4PAUE1E,EAASyD,EAAU/C,OAVrB,UAaEV,EAASyD,EAAU9C,KAbrB"}