{"version":3,"file":"nextcloud.js","sources":["../src/auth/oauth2.ts","../src/auth/nextcloud.ts"],"sourcesContent":["\r\nconst SESSION_STORE = \"_oauth2_session\";\r\n\r\ntype Oauth2Session = {\r\n  access_token?: string;\r\n  refresh_token?: string;\r\n  token_type?: string;\r\n  state?: string;\r\n  verifier?: string;\r\n};\r\n\r\nfunction sha256(plain: string) {\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(plain);\r\n  return crypto.subtle.digest(\"SHA-256\", data);\r\n}\r\n\r\nfunction base64url(bytes: ArrayBuffer | Uint8Array) {\r\n  return btoa(String.fromCharCode(...new Uint8Array(bytes)))\r\n    .replace(/\\+/g, \"-\")\r\n    .replace(/\\//g, \"_\")\r\n    .replace(/=+$/, \"\");\r\n}\r\n\r\nfunction generatePKCE() {\r\n  const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));\r\n  return sha256(verifier).then((challenge) => ({\r\n    verifier: verifier,\r\n    challenge: base64url(challenge),\r\n  }));\r\n}\r\n\r\nfunction saveSession(data: Oauth2Session) {\r\n  sessionStorage.setItem(SESSION_STORE, JSON.stringify(data));\r\n}\r\n\r\nfunction loadSession(): Oauth2Session | null {\r\n  const raw = sessionStorage.getItem(SESSION_STORE);\r\n  return raw ? JSON.parse(raw) : null;\r\n}\r\n\r\nfunction clearSession() {\r\n  sessionStorage.removeItem(SESSION_STORE);\r\n}\r\n\r\nclass Oauth2AuthProvider implements CalDavAuthProvider {\r\n  private _auth_url: URL | string;\r\n  private _token_url: URL | string;\r\n  private _client_id: string;\r\n  private _client_secret?: string;\r\n  private _redirect_url = window.location.origin + window.location.pathname;\r\n\r\n  constructor(\r\n    auth_url: URL | string,\r\n    token_url: URL | string,\r\n    client_id: string,\r\n    client_secret?: string\r\n  ) {\r\n    this._auth_url = auth_url;\r\n    this._token_url = token_url;\r\n    this._client_id = client_id;\r\n    this._client_secret = client_secret;\r\n\r\n    addEventListener(\"load\", this._callback.bind(this));\r\n  }\r\n\r\n  isLoggedIn(): boolean {\r\n    const session = loadSession();\r\n    return Boolean(session?.access_token);\r\n  }\r\n\r\n  getAuth(): string | undefined {\r\n    const session = loadSession();\r\n    if (!session?.access_token) return undefined;\r\n    return session.token_type + \" \" + session.access_token;\r\n  }\r\n\r\n  startLogin(): void {\r\n    const result = confirm(\"You need to login. You will be redirected.\");\r\n    if (!result) return;\r\n\r\n    generatePKCE().then(({ verifier, challenge }) => {\r\n      const state = crypto.randomUUID();\r\n\r\n      saveSession({ verifier, state });\r\n\r\n      const authUrl = new URL(this._auth_url);\r\n      authUrl.search = new URLSearchParams({\r\n        response_type: \"code\",\r\n        client_id: this._client_id,\r\n        redirect_uri: this._redirect_url,\r\n        code_challenge_method: \"S256\",\r\n        code_challenge: challenge,\r\n        state: state,\r\n      }).toString();\r\n\r\n      window.location.assign(authUrl.toString());\r\n    });\r\n  }\r\n\r\n  private _callback(): void {\r\n    const url = new URL(window.location.href);\r\n\r\n    if (!url.searchParams.has(\"code\")) return;\r\n\r\n    const code = url.searchParams.get(\"code\");\r\n    const returnedState = url.searchParams.get(\"state\");\r\n    const session = loadSession();\r\n\r\n    if (!session || session.state !== returnedState) {\r\n      console.error(\"OAuth state mismatch\");\r\n      clearSession();\r\n      return;\r\n    }\r\n\r\n    fetch(this._token_url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        Accept: \"application/json\",\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        \"X-Requested-With\": \"XMLHttpRequest\",\r\n      },\r\n      body: new URLSearchParams({\r\n        grant_type: \"authorization_code\",\r\n        client_id: this._client_id,\r\n        client_secret: this._client_secret || \"\",\r\n        redirect_uri: this._redirect_url,\r\n        code_verifier: session.verifier || \"\",\r\n        code: code || \"\",\r\n      }),\r\n    })\r\n      .then((response) => response.json())\r\n      .then((tokens) => {\r\n        saveSession({\r\n          access_token: tokens.access_token,\r\n          refresh_token: tokens.refresh_token,\r\n          token_type: tokens.token_type,\r\n        });\r\n        window.history.replaceState({}, \"\", this._redirect_url);\r\n      })\r\n      .catch((err) => {\r\n        clearSession();\r\n        throw err;\r\n      });\r\n  }\r\n}\r\n\r\nexport default Oauth2AuthProvider;\r\n","import Oauth2AuthProvider from \"./oauth2\";\r\n\r\nclass NextcloudAuth extends Oauth2AuthProvider {\r\n  constructor(base_url: string, client_id: string, client_secret?: string) {\r\n    const auth_url = new URL(\"/index.php/apps/oauth2/authorize\", base_url);\r\n    const token_url = new URL(\"/index.php/apps/oauth2/api/v1/token\", base_url);\r\n    super(auth_url, token_url, client_id, client_secret);\r\n  }\r\n}\r\n\r\nexport default NextcloudAuth;\r\n"],"names":["SESSION_STORE","base64url","bytes","btoa","String","fromCharCode","Uint8Array","replace","generatePKCE","verifier","crypto","getRandomValues","plain","data","TextEncoder","encode","subtle","digest","sha256","then","challenge","saveSession","sessionStorage","setItem","JSON","stringify","loadSession","raw","getItem","parse","clearSession","removeItem","Oauth2AuthProvider","_redirect_url","window","location","origin","pathname","constructor","auth_url","token_url","client_id","client_secret","this","_auth_url","_token_url","_client_id","_client_secret","addEventListener","_callback","bind","isLoggedIn","session","Boolean","access_token","getAuth","token_type","startLogin","confirm","state","randomUUID","authUrl","URL","search","URLSearchParams","response_type","redirect_uri","code_challenge_method","code_challenge","toString","assign","url","href","searchParams","has","code","get","returnedState","console","error","fetch","method","headers","Accept","body","grant_type","code_verifier","response","json","tokens","refresh_token","history","replaceState","catch","err","base_url","super"],"mappings":"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"}