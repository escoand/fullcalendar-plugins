{"version":3,"file":"nextcloud.js","sources":["../src/auth/nextcloud.ts"],"sourcesContent":["const SESSION_STORE = \"nc_oauth\";\r\n\r\ntype NextcloudSession = {\r\n  access_token?: string;\r\n  refresh_token?: string;\r\n  token_type?: string;\r\n  state?: string;\r\n  verifier?: string;\r\n};\r\n\r\nfunction sha256(plain: string) {\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(plain);\r\n  return crypto.subtle.digest(\"SHA-256\", data);\r\n}\r\n\r\nfunction base64url(bytes: ArrayBuffer | Uint8Array) {\r\n  return btoa(String.fromCharCode(...new Uint8Array(bytes)))\r\n    .replace(/\\+/g, \"-\")\r\n    .replace(/\\//g, \"_\")\r\n    .replace(/=+$/, \"\");\r\n}\r\n\r\nfunction generatePKCE() {\r\n  const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));\r\n  return sha256(verifier).then((challenge) => ({\r\n    verifier: verifier,\r\n    challenge: base64url(challenge),\r\n  }));\r\n}\r\n\r\nfunction saveSession(data: NextcloudSession) {\r\n  sessionStorage.setItem(SESSION_STORE, JSON.stringify(data));\r\n}\r\n\r\nfunction loadSession(): NextcloudSession | null {\r\n  const raw = sessionStorage.getItem(SESSION_STORE);\r\n  return raw ? JSON.parse(raw) : null;\r\n}\r\n\r\nfunction clearSession() {\r\n  sessionStorage.removeItem(SESSION_STORE);\r\n}\r\n\r\nclass NextcloudAuth implements CalDavAuthProvider {\r\n  private _base_url: string;\r\n  private _client_id: string;\r\n  private _client_secret?: string;\r\n  private _redirect_url = window.location.origin + window.location.pathname;\r\n\r\n  constructor(base_url: string, client_id: string, client_secret?: string) {\r\n    this._base_url = base_url;\r\n    this._client_id = client_id;\r\n    this._client_secret = client_secret;\r\n\r\n    addEventListener(\"load\", this._callback.bind(this));\r\n  }\r\n\r\n  isLoggedIn(): boolean {\r\n    const session = loadSession();\r\n    return Boolean(session?.access_token);\r\n  }\r\n\r\n  getAuth(): string | null {\r\n    const session = loadSession();\r\n    if (!session?.access_token) return null;\r\n    return session.token_type + \" \" + session.access_token;\r\n  }\r\n\r\n  startLogin(): void {\r\n    generatePKCE().then(({ verifier, challenge }) => {\r\n      const state = crypto.randomUUID();\r\n\r\n      saveSession({ verifier, state });\r\n\r\n      const authUrl = new URL(\r\n        \"/index.php/apps/oauth2/authorize\",\r\n        this._base_url\r\n      );\r\n      authUrl.search = new URLSearchParams({\r\n        response_type: \"code\",\r\n        client_id: this._client_id,\r\n        redirect_uri: this._redirect_url,\r\n        code_challenge_method: \"S256\",\r\n        code_challenge: challenge,\r\n        state: state,\r\n      }).toString();\r\n\r\n      window.location.replace(authUrl.toString());\r\n    });\r\n  }\r\n\r\n  private _callback(): void {\r\n    const url = new URL(window.location.href);\r\n\r\n    if (!url.searchParams.has(\"code\")) return;\r\n\r\n    const code = url.searchParams.get(\"code\");\r\n    const returnedState = url.searchParams.get(\"state\");\r\n    const session = loadSession();\r\n\r\n    if (!session || session.state !== returnedState) {\r\n      console.error(\"OAuth state mismatch\");\r\n      clearSession();\r\n      return;\r\n    }\r\n\r\n    fetch(`${this._base_url}/index.php/apps/oauth2/api/v1/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        Accept: \"application/json\",\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        \"X-Requested-With\": \"XMLHttpRequest\",\r\n      },\r\n      body: new URLSearchParams({\r\n        grant_type: \"authorization_code\",\r\n        client_id: this._client_id,\r\n        client_secret: this._client_secret,\r\n        redirect_uri: this._redirect_url,\r\n        code_verifier: session.verifier,\r\n        code: code as string,\r\n      }),\r\n    })\r\n      .then((response) => response.json())\r\n      .then((tokens) => {\r\n        saveSession({\r\n          access_token: tokens.access_token,\r\n          refresh_token: tokens.refresh_token,\r\n          token_type: tokens.token_type,\r\n        });\r\n        window.history.replaceState({}, \"\", this._redirect_url);\r\n      })\r\n      .catch((err) => {\r\n        clearSession();\r\n        throw err;\r\n      });\r\n  }\r\n}\r\n\r\nexport default NextcloudAuth;\r\n"],"names":["SESSION_STORE","base64url","bytes","btoa","String","fromCharCode","Uint8Array","replace","generatePKCE","verifier","crypto","getRandomValues","plain","data","TextEncoder","encode","subtle","digest","sha256","then","challenge","saveSession","sessionStorage","setItem","JSON","stringify","loadSession","raw","getItem","parse","clearSession","removeItem","_redirect_url","window","location","origin","pathname","constructor","base_url","client_id","client_secret","this","_base_url","_client_id","_client_secret","addEventListener","_callback","bind","isLoggedIn","session","Boolean","access_token","getAuth","token_type","startLogin","state","randomUUID","authUrl","URL","search","URLSearchParams","response_type","redirect_uri","code_challenge_method","code_challenge","toString","url","href","searchParams","has","code","get","returnedState","console","error","fetch","method","headers","Accept","body","grant_type","code_verifier","response","json","tokens","refresh_token","history","replaceState","catch","err"],"mappings":"0CAAA,MAAMA,EAAgB,WAgBtB,SAASC,EAAUC,GACjB,OAAOC,KAAKC,OAAOC,gBAAgB,IAAIC,WAAWJ,KAC/CK,QAAQ,MAAO,KACfA,QAAQ,MAAO,KACfA,QAAQ,MAAO,GACpB,CAEA,SAASC,IACP,MAAMC,EAAWR,EAAUS,OAAOC,gBAAgB,IAAIL,WAAW,MACjE,OAfF,SAAgBM,GACd,MACMC,GADU,IAAIC,aACCC,OAAOH,GAC5B,OAAOF,OAAOM,OAAOC,OAAO,UAAWJ,EACzC,CAWSK,CAAOT,GAAUU,KAAMC,IAAS,CACrCX,SAAUA,EACVW,UAAWnB,EAAUmB,KAEzB,CAEA,SAASC,EAAYR,GACnBS,eAAeC,QAAQvB,EAAewB,KAAKC,UAAUZ,GACvD,CAEA,SAASa,IACP,MAAMC,EAAML,eAAeM,QAAQ5B,GACnC,OAAO2B,EAAMH,KAAKK,MAAMF,GAAO,IACjC,CAEA,SAASG,IACPR,eAAeS,WAAW/B,EAC5B,CA+FA,OA7FA,MAIUgC,cAAgBC,OAAOC,SAASC,OAASF,OAAOC,SAASE,SAEjEC,WAAAA,CAAYC,EAAkBC,EAAmBC,GAC/CC,KAAKC,UAAYJ,EACjBG,KAAKE,WAAaJ,EAClBE,KAAKG,eAAiBJ,EAEtBK,iBAAiB,OAAQJ,KAAKK,UAAUC,KAAKN,MAC/C,CAEAO,UAAAA,GACE,MAAMC,EAAUvB,IAChB,OAAOwB,QAAQD,GAASE,aAC1B,CAEAC,OAAAA,GACE,MAAMH,EAAUvB,IAChB,OAAKuB,GAASE,aACPF,EAAQI,WAAa,IAAMJ,EAAQE,aADP,IAErC,CAEAG,UAAAA,GACE9C,IAAeW,KAAK,EAAGV,WAAUW,gBAC/B,MAAMmC,EAAQ7C,OAAO8C,aAErBnC,EAAY,CAAEZ,WAAU8C,UAExB,MAAME,EAAU,IAAIC,IAClB,mCACAjB,KAAKC,WAEPe,EAAQE,OAAS,IAAIC,gBAAgB,CACnCC,cAAe,OACftB,UAAWE,KAAKE,WAChBmB,aAAcrB,KAAKT,cACnB+B,sBAAuB,OACvBC,eAAgB5C,EAChBmC,MAAOA,IACNU,WAEHhC,OAAOC,SAAS3B,QAAQkD,EAAQQ,aAEpC,CAEQnB,SAAAA,GACN,MAAMoB,EAAM,IAAIR,IAAIzB,OAAOC,SAASiC,MAEpC,IAAKD,EAAIE,aAAaC,IAAI,QAAS,OAEnC,MAAMC,EAAOJ,EAAIE,aAAaG,IAAI,QAC5BC,EAAgBN,EAAIE,aAAaG,IAAI,SACrCtB,EAAUvB,IAEhB,IAAKuB,GAAWA,EAAQM,QAAUiB,EAGhC,OAFAC,QAAQC,MAAM,6BACd5C,IAIF6C,MAAM,GAAGlC,KAAKC,+CAAgD,CAC5DkC,OAAQ,OACRC,QAAS,CACPC,OAAQ,mBACR,eAAgB,oCAChB,mBAAoB,kBAEtBC,KAAM,IAAInB,gBAAgB,CACxBoB,WAAY,qBACZzC,UAAWE,KAAKE,WAChBH,cAAeC,KAAKG,eACpBkB,aAAcrB,KAAKT,cACnBiD,cAAehC,EAAQxC,SACvB6D,KAAMA,MAGPnD,KAAM+D,GAAaA,EAASC,QAC5BhE,KAAMiE,IACL/D,EAAY,CACV8B,aAAciC,EAAOjC,aACrBkC,cAAeD,EAAOC,cACtBhC,WAAY+B,EAAO/B,aAErBpB,OAAOqD,QAAQC,aAAa,CAAA,EAAI,GAAI9C,KAAKT,iBAE1CwD,MAAOC,IAEN,MADA3D,IACM2D,GAEZ,EACF"}