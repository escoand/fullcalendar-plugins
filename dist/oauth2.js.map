{"version":3,"file":"oauth2.js","sources":["../src/auth/oauth2.ts"],"sourcesContent":["const SESSION_STORE = \"_oauth2_session\";\r\n\r\ntype Oauth2Session = {\r\n  access_token?: string;\r\n  refresh_token?: string;\r\n  token_type?: string;\r\n  state?: string;\r\n  verifier?: string;\r\n};\r\n\r\nfunction sha256(plain: string) {\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(plain);\r\n  return crypto.subtle.digest(\"SHA-256\", data);\r\n}\r\n\r\nfunction base64url(bytes: ArrayBuffer | Uint8Array) {\r\n  return btoa(String.fromCharCode(...new Uint8Array(bytes)))\r\n    .replace(/\\+/g, \"-\")\r\n    .replace(/\\//g, \"_\")\r\n    .replace(/=+$/, \"\");\r\n}\r\n\r\nfunction generatePKCE() {\r\n  const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));\r\n  return sha256(verifier).then((challenge) => ({\r\n    verifier: verifier,\r\n    challenge: base64url(challenge),\r\n  }));\r\n}\r\n\r\nfunction saveSession(data: Oauth2Session) {\r\n  sessionStorage.setItem(SESSION_STORE, JSON.stringify(data));\r\n}\r\n\r\nfunction loadSession(): Oauth2Session | null {\r\n  const raw = sessionStorage.getItem(SESSION_STORE);\r\n  return raw ? JSON.parse(raw) : null;\r\n}\r\n\r\nfunction clearSession() {\r\n  sessionStorage.removeItem(SESSION_STORE);\r\n}\r\n\r\nclass Oauth2AuthProvider implements CalDavAuthProvider {\r\n  private _auth_url: URL | string;\r\n  private _token_url: URL | string;\r\n  private _client_id: string;\r\n  private _client_secret?: string;\r\n  private _redirect_url = window.location.origin + window.location.pathname;\r\n\r\n  constructor(\r\n    auth_url: URL | string,\r\n    token_url: URL | string,\r\n    client_id: string,\r\n    client_secret?: string\r\n  ) {\r\n    this._auth_url = auth_url;\r\n    this._token_url = token_url;\r\n    this._client_id = client_id;\r\n    this._client_secret = client_secret;\r\n\r\n    addEventListener(\"load\", this._callback.bind(this));\r\n  }\r\n\r\n  isLoggedIn(): boolean {\r\n    const session = loadSession();\r\n    return Boolean(session?.access_token);\r\n  }\r\n\r\n  getAuth(): string | undefined {\r\n    const session = loadSession();\r\n    if (!session?.access_token) return undefined;\r\n    return session.token_type + \" \" + session.access_token;\r\n  }\r\n\r\n  startLogin(): void {\r\n    generatePKCE().then(({ verifier, challenge }) => {\r\n      const state = crypto.randomUUID();\r\n\r\n      saveSession({ verifier, state });\r\n\r\n      const authUrl = new URL(this._auth_url);\r\n      authUrl.search = new URLSearchParams({\r\n        response_type: \"code\",\r\n        client_id: this._client_id,\r\n        redirect_uri: this._redirect_url,\r\n        code_challenge_method: \"S256\",\r\n        code_challenge: challenge,\r\n        state: state,\r\n      }).toString();\r\n\r\n      window.location.assign(authUrl.toString());\r\n    });\r\n  }\r\n\r\n  private _callback(): void {\r\n    const url = new URL(window.location.href);\r\n\r\n    if (!url.searchParams.has(\"code\")) return;\r\n\r\n    const code = url.searchParams.get(\"code\");\r\n    const returnedState = url.searchParams.get(\"state\");\r\n    const session = loadSession();\r\n\r\n    if (!session || session.state !== returnedState) {\r\n      console.error(\"OAuth state mismatch\");\r\n      clearSession();\r\n      return;\r\n    }\r\n\r\n    fetch(this._token_url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        Accept: \"application/json\",\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        \"X-Requested-With\": \"XMLHttpRequest\",\r\n      },\r\n      body: new URLSearchParams({\r\n        grant_type: \"authorization_code\",\r\n        client_id: this._client_id,\r\n        client_secret: this._client_secret || \"\",\r\n        redirect_uri: this._redirect_url,\r\n        code_verifier: session.verifier || \"\",\r\n        code: code || \"\",\r\n      }),\r\n    })\r\n      .then((response) => response.json())\r\n      .then((tokens) => {\r\n        saveSession({\r\n          access_token: tokens.access_token,\r\n          refresh_token: tokens.refresh_token,\r\n          token_type: tokens.token_type,\r\n        });\r\n        window.history.replaceState({}, \"\", this._redirect_url);\r\n      })\r\n      .catch((err) => {\r\n        clearSession();\r\n        throw err;\r\n      });\r\n  }\r\n}\r\n\r\nexport default Oauth2AuthProvider;\r\n"],"names":["SESSION_STORE","base64url","bytes","btoa","String","fromCharCode","Uint8Array","replace","generatePKCE","verifier","crypto","getRandomValues","plain","data","TextEncoder","encode","subtle","digest","sha256","then","challenge","saveSession","sessionStorage","setItem","JSON","stringify","loadSession","raw","getItem","parse","clearSession","removeItem","_redirect_url","window","location","origin","pathname","constructor","auth_url","token_url","client_id","client_secret","this","_auth_url","_token_url","_client_id","_client_secret","addEventListener","_callback","bind","isLoggedIn","session","Boolean","access_token","getAuth","token_type","startLogin","state","randomUUID","authUrl","URL","search","URLSearchParams","response_type","redirect_uri","code_challenge_method","code_challenge","toString","assign","url","href","searchParams","has","code","get","returnedState","console","error","fetch","method","headers","Accept","body","grant_type","code_verifier","response","json","tokens","refresh_token","history","replaceState","catch","err"],"mappings":"uCAAA,MAAMA,EAAgB,kBAgBtB,SAASC,EAAUC,GACjB,OAAOC,KAAKC,OAAOC,gBAAgB,IAAIC,WAAWJ,KAC/CK,QAAQ,MAAO,KACfA,QAAQ,MAAO,KACfA,QAAQ,MAAO,GACpB,CAEA,SAASC,IACP,MAAMC,EAAWR,EAAUS,OAAOC,gBAAgB,IAAIL,WAAW,MACjE,OAfF,SAAgBM,GACd,MACMC,GADU,IAAIC,aACCC,OAAOH,GAC5B,OAAOF,OAAOM,OAAOC,OAAO,UAAWJ,EACzC,CAWSK,CAAOT,GAAUU,KAAMC,IAAS,CACrCX,SAAUA,EACVW,UAAWnB,EAAUmB,KAEzB,CAEA,SAASC,EAAYR,GACnBS,eAAeC,QAAQvB,EAAewB,KAAKC,UAAUZ,GACvD,CAEA,SAASa,IACP,MAAMC,EAAML,eAAeM,QAAQ5B,GACnC,OAAO2B,EAAMH,KAAKK,MAAMF,GAAO,IACjC,CAEA,SAASG,IACPR,eAAeS,WAAW/B,EAC5B,CAmGA,OAjGA,MAKUgC,cAAgBC,OAAOC,SAASC,OAASF,OAAOC,SAASE,SAEjEC,WAAAA,CACEC,EACAC,EACAC,EACAC,GAEAC,KAAKC,UAAYL,EACjBI,KAAKE,WAAaL,EAClBG,KAAKG,WAAaL,EAClBE,KAAKI,eAAiBL,EAEtBM,iBAAiB,OAAQL,KAAKM,UAAUC,KAAKP,MAC/C,CAEAQ,UAAAA,GACE,MAAMC,EAAUzB,IAChB,OAAO0B,QAAQD,GAASE,aAC1B,CAEAC,OAAAA,GACE,MAAMH,EAAUzB,IAChB,GAAKyB,GAASE,aACd,OAAOF,EAAQI,WAAa,IAAMJ,EAAQE,YAC5C,CAEAG,UAAAA,GACEhD,IAAeW,KAAK,EAAGV,WAAUW,gBAC/B,MAAMqC,EAAQ/C,OAAOgD,aAErBrC,EAAY,CAAEZ,WAAUgD,UAExB,MAAME,EAAU,IAAIC,IAAIlB,KAAKC,WAC7BgB,EAAQE,OAAS,IAAIC,gBAAgB,CACnCC,cAAe,OACfvB,UAAWE,KAAKG,WAChBmB,aAActB,KAAKV,cACnBiC,sBAAuB,OACvBC,eAAgB9C,EAChBqC,MAAOA,IACNU,WAEHlC,OAAOC,SAASkC,OAAOT,EAAQQ,aAEnC,CAEQnB,SAAAA,GACN,MAAMqB,EAAM,IAAIT,IAAI3B,OAAOC,SAASoC,MAEpC,IAAKD,EAAIE,aAAaC,IAAI,QAAS,OAEnC,MAAMC,EAAOJ,EAAIE,aAAaG,IAAI,QAC5BC,EAAgBN,EAAIE,aAAaG,IAAI,SACrCvB,EAAUzB,IAEhB,IAAKyB,GAAWA,EAAQM,QAAUkB,EAGhC,OAFAC,QAAQC,MAAM,6BACd/C,IAIFgD,MAAMpC,KAAKE,WAAY,CACrBmC,OAAQ,OACRC,QAAS,CACPC,OAAQ,mBACR,eAAgB,oCAChB,mBAAoB,kBAEtBC,KAAM,IAAIpB,gBAAgB,CACxBqB,WAAY,qBACZ3C,UAAWE,KAAKG,WAChBJ,cAAeC,KAAKI,gBAAkB,GACtCkB,aAActB,KAAKV,cACnBoD,cAAejC,EAAQ1C,UAAY,GACnCgE,KAAMA,GAAQ,OAGftD,KAAMkE,GAAaA,EAASC,QAC5BnE,KAAMoE,IACLlE,EAAY,CACVgC,aAAckC,EAAOlC,aACrBmC,cAAeD,EAAOC,cACtBjC,WAAYgC,EAAOhC,aAErBtB,OAAOwD,QAAQC,aAAa,CAAA,EAAI,GAAIhD,KAAKV,iBAE1C2D,MAAOC,IAEN,MADA9D,IACM8D,GAEZ,EACF"}